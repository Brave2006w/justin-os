name: justin-os-surface
description: Surface Pro 7 variant with KDE and linux-surface kernel
base-image: ghcr.io/ublue-os/silverblue-main
image-version: 42

modules:
  # Add linux-surface repo FIRST
  - type: rpm-ostree
    repos:
      - https://pkg.surfacelinux.com/fedora/linux-surface.repo

  # Import all your existing modules
  - from-file: common-repos.yml
  - from-file: common-packages-surface.yml
  - from-file: surface-flatpaks.yml

  # Copy system files (systemd services) and scripts
  - type: files
    files:
      - source: system
        destination: /
      - source: scripts/install-surface-flatpaks.sh
        destination: /usr/bin/install-surface-flatpaks.sh

  # Microsoft fonts dependencies and installer
  - type: rpm-ostree
    install:
      - curl
      - cabextract
      - xorg-x11-font-utils # Required by msttcore-fonts-installer
      - fontconfig

  # Install Microsoft Core Fonts and configure zsh (BEFORE changing /bin/sh)
  - type: script
    scripts:
      - install-ms-fonts-build.sh
      - set-default-shell-zsh.sh
      - setup-oh-my-zsh.sh

  # Surface-specific packages
  - type: rpm-ostree
    install:
      - kernel-surface
      - kernel-surface-default-watchdog
      - iptsd
      - libwacom-surface
      - libwacom-surface-data
      - surface-secureboot
      - thermald
    remove:
      - kernel
      - kernel-core
      - kernel-modules
      - kernel-modules-core
      - kernel-modules-extra
      - libwacom
      - libwacom-data

  # Enable services
  - type: systemd
    system:
      enabled:
        - thermald.service
        - install-surface-flatpaks.service

  - type: signing
