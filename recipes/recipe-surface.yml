name: justin-os-surface
description: Surface Pro 7 variant with KDE and linux-surface kernel
base-image: ghcr.io/ublue-os/silverblue-main
image-version: 42

modules:
  # Add linux-surface repo FIRST
  - type: rpm-ostree
    repos:
      - https://pkg.surfacelinux.com/fedora/linux-surface.repo

  # Import all your existing modules
  - from-file: common-repos.yml
  - from-file: common-packages-surface.yml
  - from-file: surface-flatpaks.yml

  # Add fallback flatpak installation script
  - type: files
    files:
      - source: scripts/install-surface-flatpaks.sh
        destination: /usr/local/bin/install-surface-flatpaks.sh
      - source: scripts/validate-flatpak-ids.sh
        destination: /usr/local/bin/validate-flatpak-ids.sh

  # Microsoft fonts dependencies and installer
  - type: rpm-ostree
    install:
      - curl
      - cabextract
      - fontconfig

  # Install Microsoft Core Fonts via custom script
  - type: script
    scripts:
      - install-ms-fonts-build.sh

  # Surface-specific packages
  - type: rpm-ostree
    install:
      - kernel-surface
      - kernel-surface-default-watchdog
      - iptsd
      - libwacom-surface
      - libwacom-surface-data
      - surface-secureboot
      - thermald
    remove:
      - kernel
      - kernel-core
      - kernel-modules
      - kernel-modules-core
      - kernel-modules-extra
      - libwacom
      - libwacom-data

  # Enable thermald for better thermal management
  - type: systemd
    system:
      enabled:
        - thermald.service

  - type: signing
